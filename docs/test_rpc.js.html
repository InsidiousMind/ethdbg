<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: test_rpc.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: test_rpc.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>#! /usr/bin/env node

/**
 * @author Andrew Plaza &lt;aplaza@liquidthink.net>
 */

const Contract = require('./contract.js');
const {
  fork,
} = require('child_process');
const {
  EventEmitter,
} = require('events');

/**
 * Interact with Forked TestRPC object
 */
class TestRPC {
  /**
   *@param{string} location - location/hostname of testRPC
   *@param{string} contract - contract path
   *@param{string} contractName - name of the contract
   *@param{Logger} logger - logger class
   */
  constructor(location, contract, contractName, logger) {
    this.location = location;
    this.contract = contract;
    this.contractName = contractName;
    this.forkedBlockchain = null;
    this.forkAddress = null;
    this.logger = logger;
    this.readyEvent = new EventEmitter();
    this.hostnameMatch = new RegExp(/http:\/\/[\w]*:[\d]{4}/i);
    // attach an event emmitter object to the node child process
    // for the purpose of telling us when the forked testRPC is ready
    try {
      this.forkedBlockchain = fork('./fork.js');
    } catch (err) {
      throw new Error('Error forking blockchain: ', err);
    }
  }

  /** Sets up listeners for forked testRPC */
  initEvents() {
    this.forkedBlockchain.on('message', (msg) => {
      /* console.log("Received message!: ", msg);
       * Init goes like this
       * |----------------------------------------|
       * | TestRPC  | Dir |   Fork     | msg_num  |
       * |----------------------------------------|
       * |  recv     &lt;=     1          |     1    |
       * |  recv     &lt;=     fork_addr  |     1    | (Address of forked TestRPC)
       * |  send     =>     1          |     2    |
       * |  ready    &lt;=     'ready'    |     3    |
       * ------------------------------------------
       */
      if (msg === 1) {
        this.logger.debug('Succesfully Forked!');
      } else if (this.hostnameMatch.test(msg)) {
        this.logger.debug(`Got fork address!: ${msg}`);
        this.forkAddress = msg;
        this.forkedBlockchain.send(1);
      } else if (msg === 'ready') {
        this.logger.debug('Emitting Ready Event...');
        this.readyEvent.emit('ready');
      } else {
        throw new Error(`Could not decipher ${msg} in test_rpc on msg event`);
      }
    });

    this.forkedBlockchain.on('exit', (code) => {
      this.logger
          .debug('Forked Blockchain Exited with an exit code of: ', code);
    });

    this.forkedBlockchain.on('error', (err) => {
      this.logger.debug('Forked Blockchain exited due to: ', err);
    });
  }
  /**
   * Runs the contract that is being debugged
   */
  runContract() {
    // once the forked blockchain is ready to be deployed to, deploy contract
    this.readyEvent.on('ready', () => {
      let contract = new Contract(this.forkAddress,
        this.contract,
        ':' + this.contractName);
      contract.deploy();
      contract.test((c) => {
        let result = c.get();
        this.logger.debug('Result');
        this.logger.debug(result);
      });
    });
  }
}

/**
 * test func
 */
function testRpc() {
  const Logger = require('./logger.js');
  let logger = new Logger(5);
  let test = new TestRPC(
    'http://localhost:8545',
    './../examples/example_solidity/simple.sol',
    'SimpleStorage',
    logger
  );

  test.initEvents();
  test.runContract();
}

testRpc();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AsmSourceMap.html">AsmSourceMap</a></li><li><a href="BytecodeSourceMap.html">BytecodeSourceMap</a></li><li><a href="Debugger.html">Debugger</a></li><li><a href="Fork.html">Fork</a></li><li><a href="LineMapping.html">LineMapping</a></li><li><a href="Logger.html">Logger</a></li><li><a href="module.exports.html">exports</a></li><li><a href="TestRPC.html">TestRPC</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clc">clc</a></li><li><a href="global.html#Contract">Contract</a></li><li><a href="global.html#solc">solc</a></li><li><a href="global.html#SourceMappingDecoder">SourceMappingDecoder</a></li><li><a href="global.html#testRpc">testRpc</a></li><li><a href="global.html#URL">URL</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Nov 19 2017 19:01:53 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
